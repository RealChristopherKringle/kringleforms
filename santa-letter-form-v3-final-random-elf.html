<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Write Your Letter to Santa</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #fffbea; padding: 20px; }
    #santa-form { max-width: 600px; margin: auto; background: #ffffff; padding: 25px; border-radius: 12px; border: 2px solid #e2b8a1; transition: opacity 1s ease; }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, textarea { width: 100%; padding: 10px; margin: 6px 0 16px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
    button { width: 100%; background-color: #d84315; color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
    #confirmation, #tracker, #progress-container {
      display: none;
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 10px;
      opacity: 0;
      transition: opacity 1s ease;
    }
    #confirmation { background: #fff3e0; border: 2px dashed #c62828; text-align: center; }
    #tracker { background: #f3faff; border: 2px solid #90caf9; }
    #tracking-steps li { opacity: 0.4; transition: opacity 0.4s; list-style: none; margin-bottom: 8px; }
    .visible { display: block !important; opacity: 1 !important; }
    .hidden { opacity: 0 !important; pointer-events: none; }
  </style>
</head>
<body>
  <form id="santa-form"> <!-- form content stays unchanged -->
    <!-- ... (same as before) -->
  </form>

  <div id="progress-container"> <!-- remains unchanged --> </div>
  <div id="tracker"> <!-- remains unchanged --> </div>
  <div id="confirmation"> <!-- remains unchanged --> </div>

  <audio id="sparkle-audio" preload="auto">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_353ffed97c.mp3?filename=magic-sparkle-1-191444.mp3" type="audio/mpeg">
  </audio>

  <script>
    window.addEventListener("load", function () {
      emailjs.init("P-b54wYCmhmC0sd6R");
      const form = document.getElementById("santa-form");
      const confirmation = document.getElementById("confirmation");
      const tracker = document.getElementById("tracker");
      const progress = document.getElementById("progress-container");
      const steps = document.querySelectorAll("#tracking-steps li");
      const sparkle = document.getElementById("sparkle-audio");

      function getTemplateIdByAge(age) {
        if (age === 1) return "template_6pvl7ni";
        if (age === 2) return "template_r0uvb9b";
        if (age === 3) return "template_yqr07ah";
        if (age === 4) return "template_u8wy89a";
        if (age === 5) return "template_b3xwms9";
        if (age === 6) return "template_vu5ss5b";
        if (age === 7) return "template_2i4tiwq";
        if (age === 8) return "template_i57fhv3";
        if (age === 9) return "template_1q6jgot";
        if (age === 10) return "template_bl4975i";
        if (age === 11) return "template_yxf775l";
        if (age === 12) return "template_58llfq6";
        if (age === 13) return "template_t30y52n";
        if (age >= 14 && age <= 18) return "template_xhbsahm";
        if (age >= 19 && age <= 22) return "template_34k3otp";
        if (age >= 23) return "template_f4munhy";
        return "";
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const age = parseInt(form.age.value);
        const selectedLanguage = form.user_language.value;

        let templateId;
        if (selectedLanguage === "es") templateId = "template_age_5_Spanish";
        else if (selectedLanguage === "fr") templateId = "template_age_5_French";
        else if (selectedLanguage === "de") templateId = "template_age_5_German";
        else if (selectedLanguage === "pt") templateId = "template_age_5_Portuguese";
        else templateId = getTemplateIdByAge(age);

        const elfId = Math.floor(Math.random() * 1029) + 1;
        document.getElementById("elf-line").innerText = `🧝‍♂️ Assigned to Elf #${elfId}`;

        const formData = new FormData(form);
        const jsonObject = {};
        formData.forEach((value, key) => {
          jsonObject[key] = value;
        });

        fetch("https://script.google.com/macros/s/AKfycbx_MQS1E9TrkISyDShwAO_W_sKGEAAFMTQ-Bk3ghMcJwskXNDDqL9aNGYsLp2YQEtrEEg/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(jsonObject)
        });

        emailjs.sendForm("service_lh5tjal", templateId, form);

        // fade out form and show magic
        form.classList.add("hidden");
        setTimeout(() => {
          confirmation.classList.add("visible");
          tracker.classList.add("visible");
          progress.classList.add("visible");
          confirmation.scrollIntoView({ behavior: "smooth" });
        }, 600);

        let width = 0;
        const progressBar = document.getElementById("progress-bar");
        const animateProgress = setInterval(() => {
          if (width >= 100) clearInterval(animateProgress);
          else {
            width++;
            progressBar.style.width = width + "%";
          }
        }, 150);

        const stepDelays = [2000, 4000, 8000, 12000, 15000];
        steps.forEach((step, i) => {
          setTimeout(() => {
            step.style.opacity = 1;
            if (i === steps.length - 1 && sparkle) {
              sparkle.volume = 0.6;
              sparkle.play().catch(() => {});
            }
          }, stepDelays[i]);
        });
      });
    });

    function resetForm() {
      document.getElementById("progress-bar").style.width = "0%";
      window.location.reload();
    }
  </script>
</body>
</html>
